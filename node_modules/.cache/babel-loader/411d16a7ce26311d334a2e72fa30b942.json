{"ast":null,"code":"/*\n\tMIT License http://www.opensource.org/licenses/mit-license.php\n\tAuthor Tobias Koppers @sokra\n*/\n\"use strict\";\n\nconst Generator = require(\"../Generator\");\n\nconst Template = require(\"../Template\");\n\nconst _require = require(\"webpack-sources\"),\n      RawSource = _require.RawSource;\n\nconst WebAssemblyImportDependency = require(\"../dependencies/WebAssemblyImportDependency\");\n\nconst WebAssemblyExportImportedDependency = require(\"../dependencies/WebAssemblyExportImportedDependency\");\n/** @typedef {import(\"../NormalModule\")} NormalModule */\n\n/** @typedef {import(\"../RuntimeTemplate\")} RuntimeTemplate */\n\n/** @typedef {import(\"webpack-sources\").Source} Source */\n\n/** @typedef {import(\"../Dependency\").DependencyTemplate} DependencyTemplate */\n\n\nclass WebAssemblyJavascriptGenerator extends Generator {\n  /**\n   * @param {NormalModule} module module for which the code should be generated\n   * @param {Map<Function, DependencyTemplate>} dependencyTemplates mapping from dependencies to templates\n   * @param {RuntimeTemplate} runtimeTemplate the runtime template\n   * @param {string} type which kind of code should be generated\n   * @returns {Source} generated code\n   */\n  generate(module, dependencyTemplates, runtimeTemplate, type) {\n    const initIdentifer = Array.isArray(module.usedExports) ? Template.numberToIdentifer(module.usedExports.length) : \"__webpack_init__\";\n    let needExportsCopy = false;\n    const importedModules = new Map();\n    const initParams = [];\n    let index = 0;\n\n    for (const dep of module.dependencies) {\n      const depAsAny =\n      /** @type {any} */\n      dep;\n\n      if (dep.module) {\n        let importData = importedModules.get(dep.module);\n\n        if (importData === undefined) {\n          importedModules.set(dep.module, importData = {\n            importVar: \"m\".concat(index),\n            index,\n            request: \"userRequest\" in depAsAny ? depAsAny.userRequest : undefined,\n            names: new Set(),\n            reexports: []\n          });\n          index++;\n        }\n\n        if (dep instanceof WebAssemblyImportDependency) {\n          importData.names.add(dep.name);\n\n          if (dep.description.type === \"GlobalType\") {\n            const exportName = dep.name;\n            const usedName = dep.module && dep.module.isUsed(exportName);\n\n            if (dep.module) {\n              if (usedName) {\n                initParams.push(runtimeTemplate.exportFromImport({\n                  module: dep.module,\n                  request: dep.request,\n                  importVar: importData.importVar,\n                  originModule: module,\n                  exportName: dep.name,\n                  asiSafe: true,\n                  isCall: false,\n                  callContext: null\n                }));\n              }\n            }\n          }\n        }\n\n        if (dep instanceof WebAssemblyExportImportedDependency) {\n          importData.names.add(dep.name);\n          const usedName = module.isUsed(dep.exportName);\n\n          if (usedName) {\n            const exportProp = \"\".concat(module.exportsArgument, \"[\").concat(JSON.stringify(usedName), \"]\");\n            const defineStatement = Template.asString([\"\".concat(exportProp, \" = \").concat(runtimeTemplate.exportFromImport({\n              module: dep.module,\n              request: dep.request,\n              importVar: importData.importVar,\n              originModule: module,\n              exportName: dep.name,\n              asiSafe: true,\n              isCall: false,\n              callContext: null\n            }), \";\"), \"if(WebAssembly.Global) \".concat(exportProp, \" = \") + \"new WebAssembly.Global({ value: \".concat(JSON.stringify(dep.valueType), \" }, \").concat(exportProp, \");\")]);\n            importData.reexports.push(defineStatement);\n            needExportsCopy = true;\n          }\n        }\n      }\n    }\n\n    const importsCode = Template.asString(Array.from(importedModules, ([module, {\n      importVar,\n      request,\n      reexports\n    }]) => {\n      const importStatement = runtimeTemplate.importStatement({\n        module,\n        request,\n        importVar,\n        originModule: module\n      });\n      return importStatement + reexports.join(\"\\n\");\n    })); // create source\n\n    const source = new RawSource(['\"use strict\";', \"// Instantiate WebAssembly module\", \"var wasmExports = __webpack_require__.w[module.i];\", !Array.isArray(module.usedExports) ? \"__webpack_require__.r(\".concat(module.exportsArgument, \");\") : \"\", // this must be before import for circular dependencies\n    \"// export exports from WebAssembly module\", Array.isArray(module.usedExports) && !needExportsCopy ? \"\".concat(module.moduleArgument, \".exports = wasmExports;\") : \"for(var name in wasmExports) \" + \"if(name != \".concat(JSON.stringify(initIdentifer), \") \") + \"\".concat(module.exportsArgument, \"[name] = wasmExports[name];\"), \"// exec imports from WebAssembly module (for esm order)\", importsCode, \"\", \"// exec wasm module\", \"wasmExports[\".concat(JSON.stringify(initIdentifer), \"](\").concat(initParams.join(\", \"), \")\")].join(\"\\n\"));\n    return source;\n  }\n\n}\n\nmodule.exports = WebAssemblyJavascriptGenerator;","map":null,"metadata":{},"sourceType":"script"}